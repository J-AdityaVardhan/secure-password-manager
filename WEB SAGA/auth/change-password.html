<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Password - WEBSAGA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../admin/admin-style.css">
    <style>
        .password-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-body);
        }

        .password-card {
            max-width: 450px;
            width: 100%;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            border-radius: 10px;
            background: white;
        }

        .password-header {
            text-align: center;
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            background: #f9fafb;
            color: var(--text-main);
            border-radius: 10px 10px 0 0;
        }
    </style>
</head>

<body>
    <div class="password-container">
        <div class="password-card card">
            <div class="password-header">
                <h2 class="mb-2"><i class="bi bi-shield-lock"></i> Change Password</h2>
                <p class="mb-0">WEBSAGA - Academic ERP System</p>
            </div>
            <div class="card-body p-4">
                <form id="changePasswordForm" class="needs-validation" novalidate>
                    <!-- Old Password -->
                    <div class="mb-3">
                        <label for="oldPassword" class="form-label">Current Password</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-lock"></i></span>
                            <input type="password" class="form-control" id="oldPassword" name="oldPassword"
                                placeholder="Enter current password" required>
                            <div class="invalid-feedback">
                                Please enter your current password.
                            </div>
                        </div>
                    </div>

                    <!-- New Password -->
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-key"></i></span>
                            <input type="password" class="form-control" id="newPassword" name="newPassword"
                                placeholder="Enter new password" minlength="6" required>
                            <div class="invalid-feedback">
                                Password must be at least 6 characters long.
                            </div>
                        </div>
                        <small class="form-text text-muted">
                            Password must be at least 6 characters long.
                        </small>
                    </div>

                    <!-- Confirm Password -->
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword"
                                placeholder="Confirm new password" minlength="6" required>
                            <div class="invalid-feedback">
                                Passwords do not match.
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Change Password
                        </button>
                        <a href="../main.html" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Login
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/script.js"></script>
    document.getElementById('changePasswordForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const oldPassword = document.getElementById('oldPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    // Determine user role (defaulting to faculty if not found, or handle error)
    // In a real app we'd redirect to login if not logged in.
    const role = localStorage.getItem("userRole") || "faculty";
    const storageKey = role === "admin" ? "adminPassword" : "facultyPassword";
    const currentStoredPassword = localStorage.getItem(storageKey) || "123456";

    // Validate Old Password
    if (oldPassword !== currentStoredPassword) {
    document.getElementById('oldPassword').classList.add('is-invalid');
    // Create or update feedback element
    let feedback = document.getElementById('oldPassword').nextElementSibling;
    if (!feedback || !feedback.classList.contains('invalid-feedback')) {
    // Handled by static HTML if present, but let's ensure message
    }
    // We can't easily change the static text without ID, but the bootstrap validation styles trigger on class
    alert("Incorrect current password");
    return;
    } else {
    document.getElementById('oldPassword').classList.remove('is-invalid');
    }

    // Validate New Password match
    if (newPassword !== confirmPassword) {
    document.getElementById('confirmPassword').setCustomValidity('Passwords do not match');
    this.classList.add('was-validated');
    return;
    } else {
    document.getElementById('confirmPassword').setCustomValidity('');
    }

    if (this.checkValidity()) {
    // Save New Password
    localStorage.setItem(storageKey, newPassword);

    alert('Password changed successfully! Please login with your new password.');

    // Clear session and redirect
    localStorage.removeItem("userRole");
    window.location.href = '../main.html';
    } else {
    this.classList.add('was-validated');
    }
    });
</body>

</html>