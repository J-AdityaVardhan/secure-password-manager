<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Courses - WEBSAGA Academic ERP</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="stylesheet" href="admin-style.css">
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top bg-white shadow-sm">
        <div class="container-fluid px-4">
            <button class="btn btn-link me-3 fs-4" id="sidebarToggle">
                <i class="bi bi-list"></i>
            </button>
            <a class="navbar-brand" href="#">
                <i class="bi bi-mortarboard-fill me-2"></i>WEBSAGA Admin
            </a>
            <div class="ms-auto d-flex align-items-center">
                <span class="text-muted me-4 small">January 03, 2026</span>
                <a href="#" class="text-danger text-decoration-none" onclick="logout()">
                    Logout <i class="bi bi-box-arrow-right"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- Sidebar (minimal version - extend as needed) -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4 class="sidebar-text">ADMIN PANEL</h4>
        </div>
        <ul class="sidebar-menu mt-3">
            <!-- You can paste full menu here from your first version -->
            <li><a href="courses.html" class="active"><i class="bi bi-book"></i><span
                        class="sidebar-text">Courses</span></a></li>
            <!-- ... other menu items ... -->
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container-fluid py-4">

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="mb-0">
                    <i class="bi bi-book me-2 text-primary"></i>
                    Course Management
                </h3>
            </div>

            <!-- Search + Add button -->
            <div class="row mb-4 g-3">
                <div class="col-md-8 col-lg-9">
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="bi bi-search text-muted"></i>
                        </span>
                        <input type="text" id="searchInput" class="form-control border-start-0"
                            placeholder="Search by code, name, branch, regulation..." onkeyup="searchCourses()">
                    </div>
                </div>
                <div class="col-md-4 col-lg-3 text-md-end">
                    <button class="btn btn-primary btn-lg w-100" data-bs-toggle="modal" data-bs-target="#courseModal"
                        onclick="prepareAdd()">
                        <i class="bi bi-plus-lg me-1"></i> Add New Course
                    </button>
                </div>
            </div>

            <!-- Table -->
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle" id="courseTable">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Code</th>
                                    <th>Course Name</th>
                                    <th>Branch</th>
                                    <th>Regulation</th>
                                    <th>Year / Sem</th>
                                    <th>Type</th>
                                    <th>Elective</th>
                                    <th>Credits</th>
                                    <th>Status</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="courseModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold" id="modalTitle">Add New Course</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-2">
                    <input type="hidden" id="editId">

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Course Code <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="courseCode" required
                                placeholder="e.g. 21CS301T">
                        </div>
                        <div class="col-md-8">
                            <label class="form-label fw-bold">Course Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="courseName" required
                                placeholder="e.g. Data Structures and Algorithms">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Branch / Department <span
                                    class="text-danger">*</span></label>
                            <select class="form-select" id="branch" required>
                                <option value="">Select Branch</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Regulation <span class="text-danger">*</span></label>
                            <select class="form-select" id="regulation" required>
                                <option value="">Select Regulation</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label fw-bold">Year <span class="text-danger">*</span></label>
                            <select class="form-select" id="year" required>
                                <option value="">Select Year</option>
                                <option>I</option>
                                <option>II</option>
                                <option>III</option>
                                <option>IV</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Semester <span class="text-danger">*</span></label>
                            <select class="form-select" id="semester" required>
                                <option value="">Select Sem</option>
                                <option>I</option>
                                <option>II</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Course Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="courseType" required>
                                <option value="">Select Type</option>
                                <option>Theory</option>
                                <option>Lab</option>
                                <option>Project</option>
                                <option>Theory + Lab</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Elective Category <span
                                    class="text-danger">*</span></label>
                            <select class="form-select" id="electiveType" required>
                                <option value="">Select Category</option>
                                <option>Core</option>
                                <option>Professional Elective</option>
                                <option>Open Elective</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-bold">Credits <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="credits" min="0" max="10" step="0.5" required
                                placeholder="e.g. 3.0 or 4.5">
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary px-5" onclick="saveCourse()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script>
        let courses = [];
        const KEY = 'wsg_courses';

        const tbody = document.querySelector("#courseTable tbody");

        document.addEventListener('DOMContentLoaded', () => {
            Auth.requireAuth(['admin']);
            loadCourses();
        });

        function loadCourses() {
            courses = DB.getAll(KEY);
            // Optionally filter out courses with invalid branches if strict integrity is needed, 
            // but DB logic should handle cascade deletes, so we assume courses here are valid or we display them anyway.
            render();
        }

        function render() {
            tbody.innerHTML = "";
            courses.forEach(c => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
            <td>${c.id}</td>
            <td class="fw-medium">${c.code}</td>
            <td>${c.name}</td>
            <td>${c.branch}</td>
            <td>${c.regulation}</td>
            <td>${c.year} / ${c.sem}</td>
            <td>${c.type}</td>
            <td>${c.elective}</td>
            <td>${c.credits}</td>
            <td>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" 
                           ${c.status === 'Active' ? 'checked' : ''} 
                           onchange="toggleStatus(${c.id})">
                </div>
            </td>
            <td class="text-end">
                <button class="btn btn-sm btn-outline-primary me-1" onclick="editCourse(${c.id})">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteCourse(${c.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
                tbody.appendChild(tr);
            });
        }

        function loadDropdowns() {
            const branchSelect = document.getElementById("branch");
            const regSelect = document.getElementById("regulation");

            // Branches
            const branches = DB.getAll('wsg_branches');
            branchSelect.innerHTML = '<option value="">Select Branch</option>';
            branches.filter(b => b.status === 'Active')
                .forEach(b => {
                    branchSelect.innerHTML += `<option value="${b.code}">${b.name} (${b.code})</option>`;
                });

            // Regulations
            // Assuming DB.getAll works for any key, even if we didn't explicitly mock it in DB.init (it uses localStorage)
            const regulations = DB.getAll('wsg_regulations');
            regSelect.innerHTML = '<option value="">Select Regulation</option>';
            // If regulations are empty, we might want to default or warn, but for now just list them
            regulations.filter(r => r.status === 'Active')
                .forEach(r => {
                    regSelect.innerHTML += `<option value="${r.name}">${r.name}</option>`;
                });
        }

        function prepareAdd() {
            document.getElementById("modalTitle").textContent = "Add New Course";
            document.getElementById("editId").value = "";
            document.querySelectorAll('#courseModal input, #courseModal select').forEach(el => el.value = "");
            loadDropdowns();
        }

        function editCourse(id) {
            const course = DB.getById(KEY, id);
            if (!course) return;

            loadDropdowns();

            document.getElementById("modalTitle").textContent = "Edit Course";
            document.getElementById("editId").value = course.id;
            document.getElementById("courseCode").value = course.code;
            document.getElementById("courseName").value = course.name;
            document.getElementById("branch").value = course.branch;
            document.getElementById("regulation").value = course.regulation;
            document.getElementById("year").value = course.year;
            document.getElementById("semester").value = course.sem;
            document.getElementById("courseType").value = course.type;
            document.getElementById("electiveType").value = course.elective;
            document.getElementById("credits").value = course.credits;

            new bootstrap.Modal(document.getElementById("courseModal")).show();
        }

        function saveCourse() {
            const fields = {
                id: document.getElementById("editId"),
                code: document.getElementById("courseCode"),
                name: document.getElementById("courseName"),
                branch: document.getElementById("branch"),
                regulation: document.getElementById("regulation"),
                year: document.getElementById("year"),
                sem: document.getElementById("semester"),
                type: document.getElementById("courseType"),
                elective: document.getElementById("electiveType"),
                credits: document.getElementById("credits")
            };

            // Validation
            for (const [key, el] of Object.entries(fields)) {
                if (el.required && !el.value.trim()) {
                    alert("Please fill all required fields!");
                    el.focus();
                    return;
                }
            }

            const codeValue = fields.code.value.trim();
            // Check duplicates
            const isDuplicate = courses.some(c =>
                c.id != fields.id.value &&
                c.code.toLowerCase() === codeValue.toLowerCase()
            );

            if (isDuplicate) {
                alert("Course code already exists!");
                fields.code.focus();
                return;
            }

            const courseData = {
                code: codeValue,
                name: fields.name.value.trim(),
                branch: fields.branch.value,
                regulation: fields.regulation.value,
                year: fields.year.value,
                sem: fields.sem.value,
                type: fields.type.value,
                elective: fields.elective.value,
                credits: fields.credits.value,
                status: "Active"
            };

            if (fields.id.value) {
                DB.update(KEY, fields.id.value, courseData);
            } else {
                DB.add(KEY, courseData);
            }

            loadCourses();
            bootstrap.Modal.getInstance(document.getElementById("courseModal")).hide();
        }

        function deleteCourse(id) {
            if (!confirm("Delete this course permanently?")) return;
            DB.delete(KEY, id);
            loadCourses();
        }

        function toggleStatus(id) {
            const course = DB.getById(KEY, id);
            if (course) {
                const newStatus = course.status === "Active" ? "Inactive" : "Active";
                DB.update(KEY, id, { status: newStatus });
                loadCourses();
            }
        }

        function searchCourses() {
            const val = document.getElementById("searchInput").value.toLowerCase();
            document.querySelectorAll("#courseTable tbody tr").forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(val) ? "" : "none";
            });
        }

        function logout() {
            Auth.logout();
        }

        // Sidebar toggle
        document.getElementById('sidebarToggle')?.addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });
    </script>

    <!-- Core Modules -->
    <script src="../js/db.js"></script>
    <script src="../js/auth.js"></script>

</body>

</html>