<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>Secure Vault - WEBSAGA</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="admin-style.css">

    <style>
        /* Glassmorphism overrides */
        .vault-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .locked-screen {
            min-height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .credential-card {
            transition: transform 0.2s;
            cursor: pointer;
        }

        .credential-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .password-field {
            font-family: monospace;
            letter-spacing: 2px;
        }
    </style>
</head>

<body>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid px-4">
            <button class="btn btn-link me-3 fs-4" id="sidebarToggle">
                <i class="bi bi-list"></i>
            </button>
            <a class="navbar-brand" href="Adashboard.html">
                <i class="bi bi-shield-lock-fill me-2"></i>Secure Vault
            </a>
            <div class="ms-auto">
                <a href="#" class="text-danger text-decoration-none" onclick="logoutVault()">
                    <i class="bi bi-lock-fill"></i> Lock Vault
                </a>
            </div>
        </div>
    </nav>

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4 class="sidebar-text">ADMIN PANEL</h4>
        </div>
        <ul class="sidebar-menu mt-3">
            <li class="section-title sidebar-text">OVERVIEW</li>
            <li><a href="Adashboard.html"><i class="bi bi-speedometer2"></i> Dashboard</a></li>

            <li class="section-title sidebar-text mt-4">SECURITY</li>
            <li><a href="secure-vault.html" class="active"><i class="bi bi-shield-lock"></i> Password Vault</a></li>

            <li class="section-title sidebar-text mt-4">MASTER DATA</li>
            <li><a href="programs.html"><i class="bi bi-diagram-3"></i> Programs</a></li>
            <li><a href="branches.html"><i class="bi bi-building"></i> Departments</a></li>
            <li><a href="regulations.html"><i class="bi bi-file-text"></i> Regulations</a></li>

            <li class="section-title sidebar-text mt-4">ACADEMICS</li>
            <li><a href="courses.html"><i class="bi bi-book"></i> Courses</a></li>

            <li class="section-title sidebar-text mt-4">Others</li>
            <li><a href="../main.html"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
        </ul>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="container-fluid py-4">

            <!-- LOCK SCREEN -->
            <div id="lockScreen" class="locked-screen">
                <div class="card vault-card p-5 text-center" style="max-width: 450px; width: 100%;">
                    <div class="mb-4">
                        <i class="bi bi-shield-lock display-1 text-primary"></i>
                    </div>
                    <h3 id="lockTitle">Unlock Vault</h3>
                    <p class="text-muted mb-4" id="lockDesc">Enter your Master Password to access secure credentials.
                    </p>

                    <form onsubmit="handleUnlock(event)">
                        <div class="mb-3">
                            <input type="password" id="masterPassword" class="form-control form-control-lg text-center"
                                placeholder="Master Password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 btn-lg">
                            <i class="bi bi-unlock"></i> Unlock
                        </button>
                        <div id="unlockError" class="text-danger mt-3 small"></div>
                    </form>
                </div>
            </div>

            <!-- DASHBOARD (Hidden by default) -->
            <div id="vaultDashboard" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="bi bi-key"></i> Stored Credentials</h3>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addModal">
                        <i class="bi bi-plus-lg"></i> Add New
                    </button>
                </div>

                <!-- Credential List -->
                <div class="row g-3" id="credentialList">
                    <!-- Dynamic -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="text-center py-5 d-none">
                    <i class="bi bi-safe h1 text-muted"></i>
                    <p class="text-muted mt-2">Vault is empty.</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal fade" id="addModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <form onsubmit="saveCredential(event)">
                    <div class="modal-header">
                        <h5 class="modal-title">Save Credential</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="credId">
                        <div class="mb-3">
                            <label class="form-label">Service / Name</label>
                            <input type="text" id="credName" class="form-control"
                                placeholder="e.g. AWS Root, Faculty Admin" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Username / Email</label>
                            <input type="text" id="credUser" class="form-control" placeholder="user@example.com">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <div class="input-group">
                                <input type="password" id="credPass" class="form-control" required>
                                <button class="btn btn-outline-secondary" type="button"
                                    onclick="togglePassVisibility('credPass')">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-secondary" type="button" onclick="generatePass()">
                                    <i class="bi bi-magic"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes (Optional)</label>
                            <textarea id="credNotes" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Encrypted Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Core Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/vault.js"></script>

    <script>
        // Sidebar Toggle
        document.getElementById('sidebarToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });

        // 1. INIT
        document.addEventListener('DOMContentLoaded', () => {
            Auth.requireAuth(['admin']); // Ensure logged in as admin first
            checkVaultStatus();
        });

        function checkVaultStatus() {
            if (!Vault.hasVault()) {
                document.getElementById('lockTitle').innerText = "Create Master Password";
                document.getElementById('lockDesc').innerText = "This is a NEW Vault. Choose a strong Master Password. If you lose it, data is lost forever.";
                document.querySelector('button[type="submit"]').innerHTML = '<i class="bi bi-check-circle"></i> Create Vault';
            }
        }

        // 2. UNLOCK
        async function handleUnlock(e) {
            e.preventDefault();
            const pass = document.getElementById('masterPassword').value;
            const errorDiv = document.getElementById('unlockError');
            errorDiv.innerText = "Verifying..."; // UI feedback

            try {
                if (!Vault.hasVault()) {
                    // Create mode
                    if (pass.length < 6) {
                        errorDiv.innerText = "Password must be at least 6 characters.";
                        return;
                    }
                    await Vault.createVault(pass);
                    showDashboard();
                } else {
                    // Unlock mode
                    const success = await Vault.unlock(pass);
                    if (success) {
                        showDashboard();
                        document.getElementById('masterPassword').value = '';
                    } else {
                        errorDiv.innerText = "Incorrect Password. Decryption failed.";
                    }
                }
            } catch (err) {
                console.error(err);
                errorDiv.innerText = "An Error Occurred: " + err.message;
            }
        }

        async function showDashboard() {
            document.getElementById('lockScreen').classList.add('d-none');
            document.getElementById('vaultDashboard').classList.remove('d-none');
            renderCredentials();
        }

        function logoutVault() {
            Vault.lock();
            location.reload();
        }

        // 3. CRUD
        async function renderCredentials() {
            const list = document.getElementById('credentialList');
            const items = await Vault.getItems();

            list.innerHTML = '';

            if (items.length === 0) {
                document.getElementById('emptyState').classList.remove('d-none');
                return;
            }
            document.getElementById('emptyState').classList.add('d-none');

            items.forEach(item => {
                list.innerHTML += `
                <div class="col-md-6 col-lg-4">
                    <div class="card credential-card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-3">
                                <h5 class="card-title text-primary mb-0">${escapeHtml(item.name)}</h5>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-light" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="copyText('${escapeJs(item.password)}')">Copy Password</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="editCred('${item.id}')">Edit</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteCred('${item.id}')">Delete</a></li>
                                    </ul>
                                </div>
                            </div>
                            <p class="mb-1 text-muted small">Username</p>
                            <p class="mb-3 fw-medium">${escapeHtml(item.username)}</p>
                            
                            <p class="mb-1 text-muted small">Password</p>
                            <div class="input-group input-group-sm mb-2">
                                <input type="password" value="${escapeHtml(item.password)}" class="form-control password-field" readonly>
                                <button class="btn btn-outline-secondary" onclick="toggleRowPass(this)"><i class="bi bi-eye"></i></button>
                                <button class="btn btn-outline-secondary" onclick="copyText('${escapeJs(item.password)}')"><i class="bi bi-clipboard"></i></button>
                            </div>
                        </div>
                    </div>
                </div>`;
            });
        }

        async function saveCredential(e) {
            e.preventDefault();
            const id = document.getElementById('credId').value;
            const name = document.getElementById('credName').value;
            const user = document.getElementById('credUser').value;
            const pass = document.getElementById('credPass').value;
            const notes = document.getElementById('credNotes').value;

            const items = await Vault.getItems();

            if (id) {
                // Update
                const idx = items.findIndex(x => x.id == id);
                if (idx !== -1) items[idx] = { ...items[idx], name, username: user, password: pass, notes };
            } else {
                // Add
                const newId = Date.now().toString(); // Simple ID
                items.push({ id: newId, name, username: user, password: pass, notes });
            }

            await Vault.saveItems(items);

            bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
            e.target.reset();
            document.getElementById('credId').value = '';
            renderCredentials();
        }

        async function deleteCred(id) {
            if (confirm("Delete this credential?")) {
                let items = await Vault.getItems();
                items = items.filter(x => x.id !== id);
                await Vault.saveItems(items);
                renderCredentials();
            }
        }

        // 4. UTILS
        function togglePassVisibility(id) {
            const inp = document.getElementById(id);
            inp.type = inp.type === 'password' ? 'text' : 'password';
        }

        function toggleRowPass(btn) {
            const inp = btn.previousElementSibling;
            const isPass = inp.type === 'password';
            inp.type = isPass ? 'text' : 'password';
            btn.innerHTML = isPass ? '<i class="bi bi-eye-slash"></i>' : '<i class="bi bi-eye"></i>';
        }

        function generatePass() {
            const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+";
            let pass = "";
            for (let i = 0; i < 16; i++) {
                pass += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('credPass').value = pass;
            document.getElementById('credPass').type = 'text'; // Show generated
        }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Could show toast
                alert("Password Copied!");
            });
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function escapeJs(text) {
            if (!text) return "";
            return text.replace(/'/g, "\\'");
        }
    </script>
</body>

</html>