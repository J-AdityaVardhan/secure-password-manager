<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Faculty - WEBSAGA Academic ERP</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="stylesheet" href="admin-style.css">
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid px-4">
            <button class="btn btn-link me-3 fs-4" id="sidebarToggle">
                <i class="bi bi-list"></i>
            </button>
            <a class="navbar-brand" href="#">
                <i class="bi bi-mortarboard-fill me-2"></i>WEBSAGA Admin
            </a>
            <div class="ms-auto">
                <span class="text-muted me-4 small">January 03, 2026</span>
                <a href="../main.html" class="text-danger text-decoration-none" onclick="return confirm('Logout?')">
                    Logout <i class="bi bi-box-arrow-right"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4 class="sidebar-text">ADMIN PANEL</h4>
        </div>
        <ul class="sidebar-menu mt-3">
            <li class="section-title sidebar-text">OVERVIEW</li>
            <li><a href="Adashboard.html"><i class="bi bi-speedometer2"></i><span class="sidebar-text">
                        Dashboard</span></a></li>

            <li class="section-title sidebar-text mt-4">MASTER DATA</li>
            <li><a href="programs.html"><i class="bi bi-diagram-3"></i><span class="sidebar-text"> Programs</span></a>
            </li>
            <li><a href="branches.html"><i class="bi bi-building"></i><span class="sidebar-text"> Departments</span></a>
            </li>
            <li><a href="regulations.html"><i class="bi bi-file-text"></i><span class="sidebar-text">
                        Regulations</span></a></li>

            <li class="section-title sidebar-text mt-4">ACADEMICS</li>
            <li><a href="courses.html"><i class="bi bi-book"></i><span class="sidebar-text"> Courses</span></a></li>
            <li>
                <a href="course-plugins/index.html">
                    <i class="bi bi-puzzle"></i>
                    <span class="sidebar-text"> Course Plugins</span>
                </a>
            </li>
            <li><a href="program-branch-mapping.html"><i class="bi bi-diagram-3"></i><span class="sidebar-text">
                        Program-Branch Mapping</span></a></li>
            <li><a href="program-course-mapping.html"><i class="bi bi-link-45deg"></i><span class="sidebar-text">
                        Program-Course Mapping</span></a></li>

            <li class="section-title sidebar-text mt-4">FACULTY</li>
            <li><a href="faculty.html" class="active"><i class="bi bi-people"></i><span class="sidebar-text">
                        Faculty</span></a></li>
            <li><a href="faculty-course-mapping.html"><i class="bi bi-link-45deg"></i><span class="sidebar-text">
                        Faculty-Course Mapping</span></a></li>

            <li class="section-title sidebar-text mt-4">QUESTION PAPER</li>
            <li><a href="question-paper-generation.html"><i class="bi bi-file-earmark-text"></i><span
                        class="sidebar-text"> Generate QP</span></a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container-fluid py-4">

            <!-- Only Heading -->
            <div class="page-header">
                <h3 class="mb-1">
                    <i class="bi bi-people me-2 text-primary"></i>
                    Faculty Management
                </h3>
            </div>

            <!-- Search + Buttons -->
            <div class="d-flex flex-wrap gap-3 justify-content-between align-items-center mb-4">
                <input type="text" id="searchInput" class="form-control w-100 w-md-50"
                    placeholder="Search by name, EMPID, email or branch..." onkeyup="searchFaculty()">

                <div class="d-flex gap-2">
                    <button class="btn btn-primary px-4" data-bs-toggle="modal" data-bs-target="#facultyModal"
                        onclick="prepareAdd()">
                        <i class="bi bi-plus-lg me-1"></i>Add Faculty
                    </button>
                    <button class="btn btn-outline-success px-4"
                        onclick="alert('Bulk upload feature coming soon!\nDownload template â†’ Upload CSV/XLSX')">
                        <i class="bi bi-upload me-1"></i>Bulk Upload
                    </button>
                </div>
            </div>

            <!-- Faculty Table -->
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 text-center align-middle" id="facultyTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Honorific</th>
                                    <th>EMPID</th>
                                    <th>Name</th>
                                    <th>User Type</th>
                                    <th>Branch</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
    </div>

    <!-- Faculty Modal -->
    <div class="modal fade" id="facultyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold" id="modalTitle">Add New Faculty</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body pt-2">
                    <input type="hidden" id="editId">

                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Honorific</label>
                            <select class="form-select" id="honorific" required>
                                <option value="">Select</option>
                                <option>Dr.</option>
                                <option>Mr.</option>
                                <option>Mrs.</option>
                                <option>Ms.</option>
                                <option>Prof.</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label fw-bold">EMPID / Per. No.</label>
                            <input type="text" class="form-control" id="empId" required placeholder="e.g. FAC2023001">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Full Name</label>
                            <input type="text" class="form-control" id="name" required placeholder="e.g. Ramesh Kumar">
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-bold">User Type</label>
                            <select class="form-select" id="userType" required>
                                <option value="">Select Type</option>
                                <option>Faculty</option>
                                <option>HOD</option>
                                <option>Coordinator</option>
                                <option>Principal</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-bold">Branch</label>
                            <select class="form-select" id="branch" required>
                                <option value="">Select Branch</option>
                                <option>CSE</option>
                                <option>IT</option>
                                <option>CSE-AIML</option>
                                <option>CSE-AIDS</option>
                                <option>ECE</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-bold">Phone Number</label>
                            <input type="tel" class="form-control" id="phone" pattern="[0-9]{10}" required
                                placeholder="10-digit number">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Email</label>
                            <input type="email" class="form-control" id="email" required
                                placeholder="example@college.edu">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Password (Auto-generated)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="password" readonly
                                    placeholder="Click 'Save' to generate">
                                <button class="btn btn-outline-secondary" type="button" onclick="generatePassword()">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                            </div>
                            <small class="text-muted">Random password will be generated and can be sent via
                                email</small>
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-bold">Status</label>
                            <select class="form-select" id="status" required>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary px-5" onclick="saveFaculty()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let faculty = [];
        const KEY = 'wsg_faculty';

        const tbody = document.querySelector("#facultyTable tbody");

        document.addEventListener('DOMContentLoaded', () => {
            Auth.requireAuth(['admin']);
            loadFaculty();
        });

        function loadFaculty() {
            faculty = DB.getAll(KEY);
            renderFaculty();
        }

        function renderFaculty() {
            tbody.innerHTML = "";
            faculty.forEach(f => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                <td>${f.id}</td>
                <td>${f.honorific}</td>
                <td>${f.empId}</td>
                <td>${f.name}</td>
                <td>${f.userType}</td>
                <td>${f.branch}</td>
                <td>${f.phone}</td>
                <td>${f.email}</td>
                <td>
                    <label class="status-toggle">
                        <input type="checkbox" ${f.status === 'Active' ? 'checked' : ''} 
                               onchange="toggleStatus(${f.id})">
                        <span class="slider"></span>
                    </label>
                </td>
                <td class="text-end">
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editFaculty(${f.id})">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteFaculty(${f.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
                tbody.appendChild(tr);
            });
        }

        function generatePassword() {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*";
            let pass = "";
            for (let i = 0; i < 8; i++) { // 8 chars is enough
                pass += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById("password").value = pass;
            return pass;
        }

        function saveFaculty() {
            const id = document.getElementById("editId").value;
            const honorific = document.getElementById("honorific").value;
            const empId = document.getElementById("empId").value.trim();
            const name = document.getElementById("name").value.trim();
            const userType = document.getElementById("userType").value;
            const branch = document.getElementById("branch").value;
            const phone = document.getElementById("phone").value.trim();
            const email = document.getElementById("email").value.trim();
            let password = document.getElementById("password").value.trim();
            const status = document.getElementById("status").value;

            if (!honorific || !empId || !name || !userType || !branch || !phone || !email || !status) {
                alert("Please fill all required fields!");
                return;
            }

            // Check duplicates
            const duplicate = faculty.find(f =>
                (f.empId.toLowerCase() === empId.toLowerCase() || f.email.toLowerCase() === email.toLowerCase()) && f.id != id
            );

            if (duplicate) {
                if (duplicate.empId.toLowerCase() === empId.toLowerCase()) {
                    alert("A faculty member with the same Employee ID already exists.");
                } else {
                    alert("A faculty member with the same email already exists.");
                }
                return;
            }

            if (!password && !id) {
                password = generatePassword(); // Auto-generate if new and empty
                alert(`Generated password: ${password}`);
            } else if (!password && id) {
                // If editing and password blank, keep existing (need to fetch it or not update it)
                // BUT, DB.update replaces fields. So we must get existing.
                const existing = DB.getById(KEY, id);
                if (existing) password = existing.password;
            }

            const facultyData = {
                honorific, empId, name, userType, branch, phone, email, password, status
            };

            if (id) {
                DB.update(KEY, id, facultyData);
            } else {
                DB.add(KEY, facultyData);
            }

            loadFaculty();
            bootstrap.Modal.getInstance(document.getElementById("facultyModal")).hide();
            clearForm();
        }

        function prepareAdd() {
            document.getElementById("modalTitle").textContent = "Add New Faculty";
            document.getElementById("editId").value = "";
            clearForm();
            document.getElementById("password").value = ""; // Clear for new
        }

        function editFaculty(id) {
            const f = DB.getById(KEY, id);
            if (!f) return;

            document.getElementById("modalTitle").textContent = "Edit Faculty";
            document.getElementById("editId").value = f.id;
            document.getElementById("honorific").value = f.honorific;
            document.getElementById("empId").value = f.empId;
            document.getElementById("name").value = f.name;
            document.getElementById("userType").value = f.userType;
            document.getElementById("branch").value = f.branch;
            document.getElementById("phone").value = f.phone;
            document.getElementById("email").value = f.email;
            document.getElementById("password").value = f.password;
            document.getElementById("status").value = f.status;

            new bootstrap.Modal(document.getElementById("facultyModal")).show();
        }

        function deleteFaculty(id) {
            if (!confirm("Delete this faculty permanently?")) return;

            // Cascade delete Check?
            // DB.delete handles generic delete. Faculty-Course mapping might be affected.
            // Ideally we check mappings.
            // For now, allow delete.
            DB.delete(KEY, id);
            loadFaculty();
        }

        function toggleStatus(id) {
            const f = DB.getById(KEY, id);
            if (f) {
                const newStatus = f.status === 'Active' ? 'Inactive' : 'Active';
                DB.update(KEY, id, { status: newStatus });
                loadFaculty();
            }
        }

        function searchFaculty() {
            const val = document.getElementById("searchInput").value.toLowerCase();
            document.querySelectorAll("#facultyTable tbody tr").forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(val) ? "" : "none";
            });
        }

        function clearForm() {
            ['honorific', 'empId', 'name', 'userType', 'branch', 'phone', 'email', 'password', 'status']
                .forEach(id => document.getElementById(id).value = "");
        }

        function logout() {
            Auth.logout();
        }

        // Sidebar
        document.getElementById('sidebarToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });
    </script>

    <!-- Core Modules -->
    <script src="../js/db.js"></script>
    <script src="../js/auth.js"></script>

</body>

</html>