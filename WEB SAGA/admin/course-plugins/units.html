<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Units Management - WEBSAGA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="../admin-style.css">
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid px-4">
            <button class="btn btn-link me-3 fs-4" id="sidebarToggle">
                <i class="bi bi-list"></i>
            </button>
            <a class="navbar-brand" href="../Adashboard.html">
                <i class="bi bi-mortarboard-fill me-2"></i>WEBSAGA Admin
            </a>
            <div class="ms-auto">
                <span class="text-muted me-4 small">January 03, 2026</span>
                <a href="#" class="text-danger text-decoration-none" onclick="logout()">
                    Logout <i class="bi bi-box-arrow-right"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4 class="sidebar-text">ADMIN PANEL</h4>
        </div>
        <ul class="sidebar-menu mt-3">
            <li class="section-title sidebar-text">OVERVIEW</li>
            <li><a href="../Adashboard.html"><i class="bi bi-speedometer2"></i><span class="sidebar-text">
                        Dashboard</span></a></li>

            <li class="section-title sidebar-text mt-4">MASTER DATA</li>
            <li><a href="../programs.html"><i class="bi bi-diagram-3"></i><span class="sidebar-text">
                        Programs</span></a></li>
            <li><a href="../branches.html"><i class="bi bi-building"></i><span class="sidebar-text">
                        Departments</span></a></li>
            <li><a href="../regulations.html"><i class="bi bi-file-text"></i><span class="sidebar-text">
                        Regulations</span></a></li>

            <li class="section-title sidebar-text mt-4">ACADEMICS</li>
            <li><a href="../courses.html"><i class="bi bi-book"></i><span class="sidebar-text"> Courses</span></a></li>
            <li><a href="index.html" class="active"><i class="bi bi-puzzle"></i><span class="sidebar-text"> Course
                        Plugins</span></a></li>
            <li><a href="../program-branch-mapping.html"><i class="bi bi-diagram-3"></i><span class="sidebar-text">
                        Program-Branch Mapping</span></a></li>
            <li><a href="../branch-course-mapping.html"><i class="bi bi-link-45deg"></i><span class="sidebar-text">
                        Branch-Course Mapping</span></a></li>

            <li class="section-title sidebar-text mt-4">FACULTY</li>
            <li><a href="../faculty.html"><i class="bi bi-people"></i><span class="sidebar-text"> Faculty</span></a>
            </li>
            <li><a href="../faculty-course-mapping.html"><i class="bi bi-link-45deg"></i><span class="sidebar-text">
                        Faculty-Course Mapping</span></a></li>

            <li class="section-title sidebar-text mt-4">QUESTION PAPER</li>
            <li><a href="../question-paper-generation.html"><i class="bi bi-file-earmark-text"></i><span
                        class="sidebar-text"> Generate QP</span></a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container-fluid py-4">
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="../Adashboard.html">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="index.html">Course Plugins</a></li>
                    <li class="breadcrumb-item active">Units</li>
                </ol>
            </nav>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3><i class="bi bi-layers text-info"></i> Units Management</h3>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUnitModal"
                    onclick="prepareAdd()">
                    <i class="bi bi-plus-circle"></i> Add New Unit
                </button>
            </div>

            <!-- Search -->
            <div class="card mb-4">
                <div class="card-body">
                    <input type="text" class="form-control" id="searchUnits"
                        placeholder="Search units by name or course..." onkeyup="filterTable()">
                </div>
            </div>

            <!-- Table -->
            <div class="card">
                <div class="card-body table-responsive">
                    <table class="table table-hover" id="unitsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Unit Number</th>
                                <th>Unit Name</th>
                                <th>Course</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Unit Modal -->
    <div class="modal fade" id="addUnitModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="addUnitForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Unit</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Unit Number</label>
                            <input type="text" class="form-control" id="unitNumber" placeholder="e.g. Unit I" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Unit Name</label>
                            <input type="text" class="form-control" id="unitName" placeholder="e.g. Introduction"
                                required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Course</label>
                            <select class="form-select" id="unitCourse" required>
                                <option value="">Select Course</option>
                                <!-- Dynamic -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="unitDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="unitStatus" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Unit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Unit Modal -->
    <div class="modal fade" id="editUnitModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editUnitForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Unit</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editUnitId">
                        <div class="mb-3">
                            <label class="form-label">Unit Number</label>
                            <input type="text" class="form-control" id="editUnitNumber" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Unit Name</label>
                            <input type="text" class="form-control" id="editUnitName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Course</label>
                            <select class="form-select" id="editUnitCourse" required>
                                <option value="">Select Course</option>
                                <!-- Dynamic -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="editUnitDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="editUnitStatus" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Unit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const KEY = 'wsg_units';

        // Sidebar Toggle
        document.getElementById('sidebarToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });

        function logout() {
            Auth.logout();
        }

        document.addEventListener('DOMContentLoaded', () => {
            Auth.requireAuth(['admin']);
            loadData();
        });

        function loadData() {
            const existing = DB.getAll(KEY);
            // Verify courses functionality by loading one if needed, but safe to just load
            loadCourses();
            renderTable();
        }

        /* --- DYNAMIC COURSE LOADING --- */
        function loadCourses() {
            const courses = DB.getAll('wsg_courses');
            const addSelect = document.getElementById('unitCourse');
            const editSelect = document.getElementById('editUnitCourse');

            // Helper to populate select
            const populate = (sel) => {
                const currentVal = sel.value;
                sel.innerHTML = '<option value="">Select Course</option>';
                courses.forEach(c => {
                    if (c.status === 'Active' || c.status === 'active') {
                        sel.innerHTML += `<option value="${c.id}">${c.name} (${c.code})</option>`;
                    }
                });
                if (currentVal) sel.value = currentVal; // Restore selection if any
            };

            if (addSelect) populate(addSelect);
            if (editSelect) populate(editSelect);
        }

        const renderTable = () => {
            const units = DB.getAll(KEY);
            const courses = DB.getAll('wsg_courses');
            const tbody = document.querySelector('#unitsTable tbody');
            tbody.innerHTML = '';

            units.forEach(unit => {
                // Find course name dynamically via stored ID
                const courseObj = courses.find(c => c.id == unit.courseId);
                const courseName = courseObj ? courseObj.name : 'Unknown Course';

                let badgeClass = unit.status === 'active' ? 'bg-success' : 'bg-secondary';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${unit.id}</td>
                    <td>${unit.number}</td>
                    <td>${unit.name}</td>
                    <td>${courseName}</td>
                    <td>${unit.description}</td>
                    <td><span class="badge ${badgeClass}">${unit.status.charAt(0).toUpperCase() + unit.status.slice(1)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editUnit('${unit.id}')"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger me-1" onclick="deleteUnit('${unit.id}')"><i class="bi bi-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        };

        function prepareAdd() {
            loadCourses();
            document.getElementById('addUnitForm').reset();
        }

        const addUnitForm = document.getElementById('addUnitForm');
        addUnitForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const number = document.getElementById('unitNumber').value.trim();
            const name = document.getElementById('unitName').value.trim();
            const courseId = document.getElementById('unitCourse').value;
            const description = document.getElementById('unitDescription').value.trim();
            const status = document.getElementById('unitStatus').value;

            if (!courseId) {
                alert("Please select a course");
                return;
            }

            const units = DB.getAll(KEY);
            // Check for duplicate unit number for the same courseId
            const duplicate = units.find(u =>
                u.number.toLowerCase() === number.toLowerCase() && u.courseId == courseId
            );

            if (duplicate) {
                alert("A unit with the same number already exists for this course.");
                return;
            }

            DB.add(KEY, {
                number: number,
                name: name,
                courseId: courseId, // saving as string ID
                description: description,
                status: status
            });

            renderTable();
            addUnitForm.reset();
            bootstrap.Modal.getInstance(document.getElementById('addUnitModal')).hide();
        });

        const editUnitForm = document.getElementById('editUnitForm');
        editUnitForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const id = document.getElementById('editUnitId').value;
            const number = document.getElementById('editUnitNumber').value.trim();
            const name = document.getElementById('editUnitName').value.trim();
            const courseId = document.getElementById('editUnitCourse').value;
            const description = document.getElementById('editUnitDescription').value.trim();
            const status = document.getElementById('editUnitStatus').value;

            const units = DB.getAll(KEY);
            // Duplicate check
            const duplicate = units.find(u =>
                u.number.toLowerCase() === number.toLowerCase() && u.courseId == courseId && u.id != id
            );
            if (duplicate) {
                alert("A unit with the same number already exists for this course.");
                return;
            }

            DB.update(KEY, id, {
                number: number,
                name: name,
                courseId: courseId,
                description: description,
                status: status
            });

            renderTable();
            bootstrap.Modal.getInstance(document.getElementById('editUnitModal')).hide();
        });

        function editUnit(id) {
            const unit = DB.getById(KEY, id);
            if (!unit) return;

            loadCourses(); // Ensure options are refreshed

            document.getElementById('editUnitId').value = unit.id;
            document.getElementById('editUnitNumber').value = unit.number;
            document.getElementById('editUnitName').value = unit.name;
            document.getElementById('editUnitDescription').value = unit.description;
            document.getElementById('editUnitStatus').value = unit.status;

            // Set slight timeout to allow dropdown to populate if it wasn't already
            setTimeout(() => {
                document.getElementById('editUnitCourse').value = unit.courseId;
            }, 50);

            new bootstrap.Modal(document.getElementById('editUnitModal')).show();
        }

        function deleteUnit(id) {
            if (confirm('Are you sure you want to delete this unit?')) {
                DB.delete(KEY, id);
                renderTable();
            }
        }

        function filterTable() {
            const filter = document.getElementById('searchUnits').value.toLowerCase();
            const rows = document.querySelectorAll('#unitsTable tbody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        }
    </script>

    <!-- Core Modules -->
    <script src="../../js/db.js"></script>
    <script src="../../js/auth.js"></script>

</body>

</html>