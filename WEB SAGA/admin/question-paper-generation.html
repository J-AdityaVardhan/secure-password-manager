<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Question Paper Generator - WEBSAGA Admin</title>

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
	<link rel="stylesheet" href="admin-style.css">

	<style>
		.question-paper-container {
			max-width: 21cm;
			margin: auto;
			background: white;
			min-height: 29.7cm;
		}

		.question-block {
			margin-bottom: 18px;
		}

		.generated-paper {
			border: 1px solid #ddd;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
		}

		@media print {

			.no-print,
			.sidebar,
			.navbar {
				display: none !important
			}

			.main-content {
				margin: 0;
				padding: 0;
			}

			.question-paper-container {
				box-shadow: none;
				border: none;
				width: 100%;
				max-width: 100%;
			}

			body {
				background: white;
			}
		}
	</style>
</head>

<body>

	<!-- NAVBAR -->
	<nav class="navbar navbar-expand-lg fixed-top">
		<div class="container-fluid px-4">
			<button class="btn btn-link me-3 fs-4" id="sidebarToggle">
				<i class="bi bi-list"></i>
			</button>
			<a class="navbar-brand" href="Adashboard.html">
				<i class="bi bi-mortarboard-fill me-2"></i>WEBSAGA Admin
			</a>
			<div class="ms-auto">
				<a href="../main.html" class="text-danger text-decoration-none" onclick="return confirm('Logout?')">
					<a href="../main.html" class="text-danger text-decoration-none" onclick="logout()">
						Logout <i class="bi bi-box-arrow-right"></i>
					</a>
			</div>
		</div>
	</nav>

	<!-- SIDEBAR -->
	<div class="sidebar" id="sidebar">
		<div class="sidebar-header">
			<h4 class="sidebar-text">ADMIN PANEL</h4>
		</div>
		<ul class="sidebar-menu mt-3">
			<li class="section-title sidebar-text">OVERVIEW</li>
			<li><a href="Adashboard.html"><i class="bi bi-speedometer2"></i> Dashboard</a></li>

			<li class="section-title sidebar-text mt-4">MASTER DATA</li>
			<li><a href="programs.html"><i class="bi bi-diagram-3"></i> Programs</a></li>
			<li><a href="branches.html"><i class="bi bi-building"></i> Departments</a></li>
			<li><a href="regulations.html"><i class="bi bi-file-text"></i> Regulations</a></li>

			<li class="section-title sidebar-text mt-4">ACADEMICS</li>
			<li><a href="courses.html"><i class="bi bi-book"></i> Courses</a></li>
			<li><a href="course-outcomes.html"><i class="bi bi-bullseye"></i> Course Outcomes</a></li>
			<li><a href="course-plugins/index.html"><i class="bi bi-puzzle"></i> Course Plugins</a></li>
			<li><a href="program-branch-mapping.html"><i class="bi bi-diagram-3"></i> Program-Branch Mapping</a></li>
			<li><a href="branch-course-mapping.html"><i class="bi bi-link-45deg"></i> Branch-Course Mapping</a></li>

			<li class="section-title sidebar-text mt-4">FACULTY</li>
			<li><a href="faculty.html"><i class="bi bi-people"></i> Faculty</a></li>
			<li><a href="faculty-course-mapping.html"><i class="bi bi-link-45deg"></i> Faculty-Course Mapping</a></li>

			<li class="section-title sidebar-text mt-4">QUESTION PAPER</li>
			<li><a href="question-paper-generation.html" class="active"><i class="bi bi-file-earmark-text"></i> Generate
					QP</a></li>
		</ul>
	</div>

	<!-- MAIN CONTENT -->
	<div class="main-content">
		<div class="container-fluid py-4">

			<div class="page-header mb-4 no-print">
				<h3><i class="bi bi-magic"></i> automated Question Paper Generator</h3>
				<p class="text-muted">Generate official papers using WEBSAGA's AI Question Engine.</p>
			</div>

			<!-- CONFIG -->
			<div class="card mb-4 no-print glass-panel">
				<div class="card-body row g-3">

					<div class="col-md-6">
						<label class="form-label">Select Course</label>
						<select id="filterCourse" class="form-select">
							<option value="">-- Select Course --</option>
							<!-- Populated dynamically -->
						</select>
					</div>

					<div class="col-md-6">
						<label class="form-label">Type of Examination</label>
						<select id="examType" class="form-select">
							<option value="Semester Examination">Semester Examination</option>
							<option value="Mid Semester Examination">Mid Semester Examination</option>
							<option value="Internal Assessment">Internal Assessment</option>
							<option value="Class Test">Class Test</option>
							<option value="Assignment">Assignment</option>
						</select>
					</div>

					<div class="col-md-4">
						<label class="form-label">Total Marks</label>
						<input type="number" id="totalMarks" class="form-control" value="100">
					</div>

					<div class="col-md-4">
						<label class="form-label">No. of Questions</label>
						<input type="number" id="numQuestions" class="form-control" value="10" min="1">
					</div>

					<div class="col-md-4">
						<label class="form-label">Paper Date</label>
						<input type="date" id="paperDate" class="form-control">
					</div>

					<div class="col-md-12">
						<hr class="text-muted">
						<h6><i class="bi bi-funnel"></i> Constraints</h6>
					</div>

					<div class="col-md-3">
						<label class="form-label">CO Priority</label>
						<select id="filterCO" class="form-select">
							<option value="">Balanced (All COs)</option>
							<option>CO1</option>
							<option>CO2</option>
							<option>CO3</option>
							<option>CO4</option>
							<option>CO5</option>
						</select>
					</div>

					<div class="col-md-3">
						<label class="form-label">Difficulty</label>
						<select id="filterDifficulty" class="form-select">
							<option value="">Balanced Mix</option>
							<option>Easy</option>
							<option>Medium</option>
							<option>Hard</option>
						</select>
					</div>

					<div class="col-md-6 pt-4 text-secondary small">
						* Uses internal database. No manual question entry required.
					</div>

					<div class="col-12 text-end mt-4">
						<button class="btn btn-primary px-4" onclick="generatePaper()">
							<i class="bi bi-cpu"></i> Generate Paper
						</button>
					</div>

				</div>
			</div>

			<!-- QUESTION PAPER PREVIEW -->
			<div id="qpPreview" class="question-paper-container card p-5 generated-paper d-none">
				<!-- Header -->
				<div class="text-center border-bottom pb-3 mb-4">
					<h5 class="fw-bold fs-4 mb-2">WEBSAGA INSTITUTE OF TECHNOLOGY</h5>
					<h6 class="fw-bold text-uppercase mb-3" id="paperExamName">Semester Examination</h6>
					<div class="d-flex justify-content-between text-muted small px-4">
						<span id="paperCourseName">Course: ---</span>
						<span id="paperDateDisplay">Date: ---</span>
						<span>Max Marks: <span id="paperMaxMarks">--</span></span>
					</div>
				</div>

				<!-- Questions -->
				<div id="questionsContainer"></div>

				<!-- Footer -->
				<div class="border-top pt-3 mt-4 text-center small text-muted">
					<p>*** End of Question Paper ***</p>
					<p>Generated by WebSaga AI Engine</p>
				</div>

				<div class="text-center mt-5 no-print">
					<button class="btn btn-dark" onclick="window.print()">
						<i class="bi bi-printer"></i> Print / Save as PDF
					</button>
				</div>
			</div>

		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script>
		document.getElementById('sidebarToggle').addEventListener('click', () => {
			document.getElementById('sidebar').classList.toggle('collapsed');
		});

		document.addEventListener('DOMContentLoaded', () => {
			Auth.requireAuth(['admin']);
			loadCourses();
		});

		let allCourses = [];

		function loadCourses() {
			allCourses = DB.getAll('wsg_courses');
			// Fallback handled by DB? No, DB return empty if empty.
			// If empty, we can just leave it empty or mock.
			// Let's assume DB has courses by now.

			const courseSelect = document.getElementById('filterCourse');
			allCourses.forEach(c => {
				if (c.status === 'Active' || c.status === 'active') { // Handle case sensitivity
					const opt = document.createElement('option');
					opt.value = c.code;
					opt.innerText = `${c.name} (${c.code})`;
					courseSelect.appendChild(opt);
				}
			});
		}

		/* =========================================
		   INTERNAL QUESTION ENGINE
		   ========================================= */

		// 2. TEMPLATES
		const templates = {
			Easy: [
				"Define {topic} and list its key characteristics.",
				"What is {topic}? Explain briefly.",
				"List the advantages of {topic}.",
				"Explain the basic concept of {topic}.",
				"Differentiate between {topic} and its alternative."
			],
			Medium: [
				"Explain {topic} with a suitable example.",
				"Describe the architecture/structure of {topic}.",
				"Discuss the working principle of {topic}.",
				"How does {topic} impact system performance?",
				"Explain the implementation steps for {topic}."
			],
			Hard: [
				"Analyze the complexity of {topic} in detail.",
				"Design a system that utilizes {topic} for optimization.",
				"Critically evaluate the role of {topic} in modern computing.",
				"Implement a robust solution using {topic} and explain your logic.",
				"Compare {topic} with advanced alternatives in terms of efficiency."
			]
		};

		const topics = [
			"Data Structures", "Algorithms", "Operating Systems", "Database Normalization",
			"Machine Learning", "Neural Networks", "Cloud Computing", "Network Security",
			"Software Engineering", "Web Technologies", "API Design", "Microservices"
		];

		const cos = ["CO1", "CO2", "CO3", "CO4", "CO5"];
		const blooms = ["Remember", "Understand", "Apply", "Analyze", "Evaluate"];
		const units = ["Unit I", "Unit II", "Unit III", "Unit IV", "Unit V"];

		function getRandomItem(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

		// 3. GENERATION
		function generatePaper() {
			const courseCode = document.getElementById('filterCourse').value;
			const maxMarks = parseInt(document.getElementById('totalMarks').value);
			const numQ = parseInt(document.getElementById('numQuestions').value);
			const pDate = document.getElementById('paperDate').value;
			const examType = document.getElementById('examType').value;

			if (!courseCode) { alert("Please select a course."); return; }
			if (!numQ || numQ < 1) { alert("Please enter valid number of questions."); return; }

			// Logic: Distribute marks
			const marksPerQ = Math.floor(maxMarks / numQ);
			const remainder = maxMarks % numQ;

			let questions = [];

			for (let i = 1; i <= numQ; i++) {
				// Decide Difficulty
				const diff = getRandomItem(['Easy', 'Medium', 'Hard']);

				// Assign marks
				let qMarks = marksPerQ;
				if (i <= remainder) qMarks += 1;

				const topic = getRandomItem(topics);
				const template = getRandomItem(templates[diff] || templates['Easy']);
				const text = template.replace("{topic}", topic);

				questions.push({
					idx: i,
					text: text,
					marks: qMarks,
					co: getRandomItem(cos),
					bloom: getRandomItem(blooms),
					unit: getRandomItem(units),
					difficulty: diff
				});
			}

			renderPaper(questions, courseCode, pDate, maxMarks, examType);
		}

		function renderPaper(questions, courseCode, date, maxMarks, examType) {
			const container = document.getElementById('questionsContainer');
			const courseObj = allCourses.find(c => c.code === courseCode);

			document.getElementById('paperExamName').innerText = examType || "Semester Examination";
			document.getElementById('paperCourseName').innerText = `Course: ${courseObj ? courseObj.name : courseCode}`;
			document.getElementById('paperDateDisplay').innerText = `Date: ${date || new Date().toLocaleDateString()}`;
			document.getElementById('paperMaxMarks').innerText = maxMarks;

			let html = '<div class="list-group list-group-flush">';
			questions.forEach(q => {
				html += `
             <div class="list-group-item border-0 px-0 py-3">
                <div class="d-flex">
                    <div class="fw-bold me-2">Q${q.idx}.</div>
                    <div class="flex-grow-1">
                        <div>${q.text}</div>
                        <div class="mt-1 small text-muted">
                            <span class="me-3">[${q.co}]</span>
                            <span class="me-3">[${q.bloom}]</span>
                            <span class="me-3">[${q.unit}]</span>
                            <span class="badge bg-light text-secondary border">${q.difficulty}</span>
                        </div>
                    </div>
                    <div class="fw-bold">(${q.marks})</div>
                </div>
             </div>`;
			});
			html += '</div>';

			container.innerHTML = html;
			document.getElementById('qpPreview').classList.remove('d-none');
			document.getElementById('qpPreview').scrollIntoView({ behavior: 'smooth' });
		}

		function logout() {
			Auth.logout();
		}
	</script>

	<!-- Core Modules -->
	<script src="../js/db.js"></script>
	<script src="../js/auth.js"></script>

</body>

</html>